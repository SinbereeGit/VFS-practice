# 说明

## 功能说明

这个人很懒, 什么都没留下...

## 设计说明

暂且只是把我们之前在 `_dir_tree_handler` 模块中的类 `DirTreeHandler` 的 `docstring` 中写的东西随便排了一下版之后直接放在了这里.

### 关于结点名称

是 `str` 类型的.

结点的名称中不能包含 `'/'`, 这是因为对该模块的使用中, 常见的路径的分割依赖于 `'/'`, 只有一个例外, 即根结点 `['/']`.

创建结点的名称不能是空的, 因为这样的名称实在是太糟糕了.

### 关于路径

这里当然是不把 `json_path` 考虑进来的.

除此之外, 所有的路径都是 *列表路径*.

> 这使得这里的路径是操作系统无关的.
>
> 现在关于路径 (更准确地说是 *结点*) 的名称还没有任何限制, 只是限制了不能包含 `'/'`  以及 不为空字符.

#### 列表路径

由 结点名 按顺序组成的列表.

当前路径: `[]`.

根路径: `['/']`.

##### 绝对路径, 相对路径

前者的第一个元素是 `'/'`, 后者不是.

    比如, ['/', 'a', 'b'] 是绝对路径, ['a', 'b'] 是相对路径.

*相对路径* 是相对于当前路径的.

#### 当前路径

该路径除非 主动切换, 否则不会改变.

路径的切换支持 *向前走*, 但如果要 *向后退*, 必须使用绝对路径.

能且只能通过 *goto 方法* 改变 (参见 [内部一致处理](#内部一致处理) 中对 *goto 方法* 的定义).

### 关于元数据

有两个内部属性 -- *创建时间* 和 *最后修改时间*, 它们的 `key` 分别是 `'0'`, `'1'`.

系统内部维护 *创建时间* 和 *最后修改时间*, 维护是递归的 (特别地, 根目录 `['/']` 没有 *元数据*).

特别地, 根目录 `['/']` 没有元数据, 也不支持对其的元数据的处理, 也不对其维护 *创建时间* 和 *最后修改时间*.

#### 一些限制

**不要** 使用 `'0'`, `'1'` 作为元数据的 `key`.

**不要** 尝试修改 *创建时间* 和 *最后修改时间* 的值, 因为它们是系统内部维护的.

**不要** 使用非字符串作为 `key`.  
否则容易导致存储的时候有重复的键值.
比如对于 键值 `1`, `'1'`, 它们 `dump` 为 `json` 的时候都是 `1`, 但 `load` 的时候只会保留最后一个 `key`, 这显然会造成混乱.

> 这些要求现在都不是强制的 (也就是该模块在这种操作下不会报错), 但是不遵守这些规则可能会带来混乱甚至错误.

### 目录树的结构

这里实际上用字典构造了这棵树.

可以将其存储为 *json* 文件.

#### 结点结构

一个列表, 内容如下:

- 是否是目录.
- 保存各种元数据信息的字典.
- 内容:
  - 如果是目录, 则是一个子结点字典 (key为子结点名, value为子结点指针) .
  - 如果是普通文件, 则是一个散列值.

#### 结点操作

只需注意一点, 操作是 **覆盖式的**.

### 内部一致处理

#### 放在最前面

- 下面所说的“方法”不包括“内部函数”.
- 有些东西放在了”现在的实现“中.
- 应当特别注意使用 “引用” 赋值带来的影响, 有时候很容易忽略这一点.

#### 方法的约定

> 遵循 *[无副作用原则]*

称方法 `__goto_dir`, `__goto_path`, `chdir` 为 "*goto 方法*".

除了 *goto 方法*, `__backward` 方法, 其他方法都保证调用的时候 *当前目录* 在调用前后不变.  
特别地, 如果调用 *goto 方法* "失败", *当前目录* 不变.

除了 *goto 方法*, `__save`、`__backward` 和 `__set_state`, 其他方法都保证调用前后四个成员变量 -- `__old_dir`, `__old_dir_path`, `__current_dir`、`__current_dir_path` 的值是不变的.

该模块使用的所有路径都是 *列表路径* (当然, `json_path` 除外).

每个方法都需特别注意根路径和当前路径的处理.

### 为将来实现的准备

暂无.

### 为高效实现的准备

暂无.

[无副作用原则]: ./virtual_file_system.md#对方法的要求
